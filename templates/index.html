<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Sentiment Analysis Dashboard</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
  <!-- Animated theme switch (no stray checkboxes) -->
  <div class="theme-toggle" aria-hidden="false">
    <label class="switch" title="Toggle dark / light">
      <input id="themeToggle" type="checkbox" aria-label="Toggle theme" />
      <span class="slider">
        <span class="icon sun">â˜€ï¸</span>
        <span class="icon moon">ğŸŒ™</span>
      </span>
    </label>
  </div>

  <main class="container" role="main">
    <header class="hero">
      <h1>ğŸ§  <span>Sentiment Analysis</span></h1>
      <p class="subtitle">Compare <strong>VADER</strong> and <strong>RoBERTa</strong> sentiment models</p>
    </header>

    <form action="/predict" method="POST" class="form-box" aria-label="Sentiment input">
      <textarea name="text" placeholder="Enter text to analyze..." aria-label="Text to analyze">{{ original or '' }}</textarea>
      <div class="form-actions">
        <button type="submit" class="primary-btn">Analyze</button>
      </div>
    </form>

    {% if cleaned %}
    <section class="result-section" aria-live="polite">
      <h3>ğŸ§¹ Cleaned Text:</h3>
      <div class="cleaned-text">{{ cleaned }}</div>

      <h3>ğŸ“Š Predictions:</h3>

      <!-- VADER -->
      <article class="result-card" aria-label="VADER result">
        <h4>VADER Result: <span class="highlight">{{ vader_label|capitalize }}</span>
          {% if vader_label == 'positive' %} ğŸ˜Š {% elif vader_label == 'negative' %} ğŸ˜ {% else %} ğŸ˜ {% endif %}
        </h4>

        <div class="bar-group" aria-hidden="false">
          <div class="bar positive" style="width: {{ vader_scores.positive * 100 }}%">
            <span>Positive: {{ "%.3f"|format(vader_scores.positive) }}</span>
          </div>
          <div class="bar neutral" style="width: {{ vader_scores.neutral * 100 }}%">
            <span>Neutral: {{ "%.3f"|format(vader_scores.neutral) }}</span>
          </div>
          <div class="bar negative" style="width: {{ vader_scores.negative * 100 }}%">
            <span>Negative: {{ "%.3f"|format(vader_scores.negative) }}</span>
          </div>
        </div>
      </article>

      <!-- RoBERTa -->
      <article class="result-card" aria-label="RoBERTa result">
        <h4>RoBERTa Result: <span class="highlight">{{ roberta_label|capitalize }}</span>
          {% if roberta_label == 'positive' %} ğŸ˜Š {% elif roberta_label == 'negative' %} ğŸ˜ {% else %} ğŸ˜ {% endif %}
        </h4>

        <div class="bar-group" aria-hidden="false">
          <div class="bar positive" style="width: {{ roberta_scores.positive * 100 }}%">
            <span>Positive: {{ "%.3f"|format(roberta_scores.positive) }}</span>
          </div>
          <div class="bar neutral" style="width: {{ roberta_scores.neutral * 100 }}%">
            <span>Neutral: {{ "%.3f"|format(roberta_scores.neutral) }}</span>
          </div>
          <div class="bar negative" style="width: {{ roberta_scores.negative * 100 }}%">
            <span>Negative: {{ "%.3f"|format(roberta_scores.negative) }}</span>
          </div>
        </div>
      </article>
    </section>
    {% endif %}

    {% if metrics %}
    <section class="chart-section">
      <h3 class="chart-title">ğŸ“ˆ Model Comparison (Sample 100 Tweets)</h3>
      <div class="chart-box">
        <canvas id="metricsChart" width="600" height="320" aria-label="Model comparison chart"></canvas>
      </div>
    </section>
    {% endif %}

    <footer class="app-footer">Made with â¤ï¸ using Flask, VADER & RoBERTa</footer>
  </main>

  {% if metrics %}
  <script>
    // Chart setup with theme-aware colors (updates occur on theme toggles below)
    const ctx = document.getElementById('metricsChart')?.getContext('2d');
    let themeIsDark = localStorage.getItem('theme') === 'dark';
    function chartColors(dark) {
      return {
        text: dark ? '#e7e7e7' : '#111111',
        grid: dark ? 'rgba(255,255,255,0.06)' : 'rgba(0,0,0,0.06)',
        vader: dark ? 'rgba(80,180,255,0.9)' : 'rgba(54,162,235,0.8)',
        roberta: dark ? 'rgba(255,150,175,0.9)' : 'rgba(255,99,132,0.8)'
      };
    }

    let chart;
    if (ctx) {
      const colors = chartColors(themeIsDark);
      chart = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: ['Accuracy','Precision','Recall','F1 Score'],
          datasets: [
            { label: 'VADER', data: [{{ metrics.vader.accuracy }}, {{ metrics.vader.precision }}, {{ metrics.vader.recall }}, {{ metrics.vader.f1 }}], backgroundColor: colors.vader, borderRadius: 6 },
            { label: 'RoBERTa', data: [{{ metrics.roberta.accuracy }}, {{ metrics.roberta.precision }}, {{ metrics.roberta.recall }}, {{ metrics.roberta.f1 }}], backgroundColor: colors.roberta, borderRadius: 6 }
          ]
        },
        options: {
          animation: { duration: 900, easing: 'easeOutCubic' },
          scales: {
            x: { ticks: { color: colors.text }, grid: { display: false } },
            y: { beginAtZero: true, max: 1, ticks: { color: colors.text }, grid: { color: colors.grid } }
          },
          plugins: { legend: { labels: { color: colors.text } } }
        }
      });
    }
  </script>
  {% endif %}

  <script>
    // Theme toggle logic: initializes state, updates body class and chart colors.
    const body = document.body;
    const toggle = document.getElementById('themeToggle');
    const saved = localStorage.getItem('theme');

    function applyTheme(isDark) {
      if (isDark) body.classList.add('dark-mode'); else body.classList.remove('dark-mode');
      localStorage.setItem('theme', isDark ? 'dark' : 'light');

      // update chart colors if chart exists
      if (typeof chart !== 'undefined' && chart) {
        const colors = (isDark) ? { text:'#e7e7e7', grid:'rgba(255,255,255,0.06)', vader:'rgba(80,180,255,0.9)', roberta:'rgba(255,150,175,0.9)' } :
                                 { text:'#111111', grid:'rgba(0,0,0,0.06)', vader:'rgba(54,162,235,0.8)', roberta:'rgba(255,99,132,0.8)' };
        chart.options.scales.x.ticks.color = colors.text;
        chart.options.scales.y.ticks.color = colors.text;
        chart.options.scales.y.grid.color = colors.grid;
        chart.data.datasets[0].backgroundColor = colors.vader;
        chart.data.datasets[1].backgroundColor = colors.roberta;
        chart.options.plugins.legend.labels.color = colors.text;
        chart.update();
      }
    }

    // initialize on load
    if (saved === 'dark') {
      toggle.checked = true;
      applyTheme(true);
    } else {
      toggle.checked = false;
      applyTheme(false);
    }

    toggle.addEventListener('change', () => {
      applyTheme(toggle.checked);
    });

    // Bar animation (also ensures tiny bars are still visible)
    window.addEventListener('load', () => {
      document.querySelectorAll('.bar').forEach((bar, i) => {
        const style = bar.getAttribute('style') || '';
        const m = style.match(/width:\s*([\d.]+)%/);
        const pct = m ? Math.max(parseFloat(m[1]), 4) : 4; // ensure minimum visual width (4%)
        bar.style.width = '0%';
        setTimeout(() => {
          bar.classList.add('visible');
          bar.style.width = pct + '%';
        }, 220 + i * 110);
      });
    });
  </script>
</body>
</html>
